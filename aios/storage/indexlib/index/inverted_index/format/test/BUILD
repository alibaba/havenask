load('//aios/storage:defs.bzl', 'strict_cc_fast_test', 'strict_cc_library')
load('//bazel:defs.bzl', 'if_clang')
strict_cc_library(
    name='SuspendableThread', testonly=True, deps=['//aios/autil:log']
)
strict_cc_fast_test(
    name='indexlib_format_unittest',
    srcs=[
        'BufferedByteSlicePerfTest.cpp', 'BufferedByteSliceReaderTest.cpp',
        'BufferedByteSliceTest.cpp', 'DictInlineDecoderTest.cpp',
        'DictInlineEncoderTest.cpp', 'DictInlineFormatterTest.cpp',
        'DictInlinePostingDecoderTest.cpp', 'DocListEncoderTest.cpp',
        'DocListFormatOptionTest.cpp', 'FlushInfoTest.cpp',
        'InDocPositionIteratorStateTest.cpp', 'InMemDocListDecoderTest.cpp',
        'InMemPositionListDecoderTest.cpp', 'IndexFormatOptionTest.cpp',
        'NormalInDocStateTest.cpp', 'PositionBitmapReaderTest.cpp',
        'PositionListEncoderTest.cpp', 'PositionListFormatOptionTest.cpp',
        'PositionListSegmentDecoderTest.cpp', 'PostingDecoderImplTest.cpp',
        'PostingFormatOptionTest.cpp', 'PostingFormatTest.cpp',
        'ShortListOptimizeUtilTest.cpp', 'TermMetaLoaderTest.cpp',
        'TermMetaTest.cpp'
    ],
    copts=(['-fno-access-control'] + if_clang(['-std=c++20'])),
    data=glob(['testdata/**']),
    shard_count=2,
    deps=[
        ':SuspendableThread', '//aios/storage/indexlib/file_system',
        '//aios/storage/indexlib/framework:tablet_schema_loader',
        '//aios/storage/indexlib/index/inverted_index:PostingWriterImpl',
        '//aios/storage/indexlib/index/inverted_index/format:BufferedByteSlice',
        '//aios/storage/indexlib/index/inverted_index/format:BufferedByteSliceReader',
        '//aios/storage/indexlib/index/inverted_index/format:BufferedSegmentIndexDecoder',
        '//aios/storage/indexlib/index/inverted_index/format:ComplexDocid',
        '//aios/storage/indexlib/index/inverted_index/format:DictInlineDecoder',
        '//aios/storage/indexlib/index/inverted_index/format:DictInlineEncoder',
        '//aios/storage/indexlib/index/inverted_index/format:DictInlineFormatter',
        '//aios/storage/indexlib/index/inverted_index/format:DictInlinePostingDecoder',
        '//aios/storage/indexlib/index/inverted_index/format:DocListEncoder',
        '//aios/storage/indexlib/index/inverted_index/format:DocListEncoderImproved',
        '//aios/storage/indexlib/index/inverted_index/format:DocListFormat',
        '//aios/storage/indexlib/index/inverted_index/format:DocListFormatOption',
        '//aios/storage/indexlib/index/inverted_index/format:DocListSkipListFormat',
        '//aios/storage/indexlib/index/inverted_index/format:FlushInfo',
        '//aios/storage/indexlib/index/inverted_index/format:InMemDictInlineDocListDecoder',
        '//aios/storage/indexlib/index/inverted_index/format:InMemDocListDecoder',
        '//aios/storage/indexlib/index/inverted_index/format:InMemPositionListDecoder',
        '//aios/storage/indexlib/index/inverted_index/format:InMemPostingDecoder',
        '//aios/storage/indexlib/index/inverted_index/format:IndexFormatOption',
        '//aios/storage/indexlib/index/inverted_index/format:NormalInDoc',
        '//aios/storage/indexlib/index/inverted_index/format:PatchFormat',
        '//aios/storage/indexlib/index/inverted_index/format:PositionBitmapReader',
        '//aios/storage/indexlib/index/inverted_index/format:PositionBitmapWriter',
        '//aios/storage/indexlib/index/inverted_index/format:PositionListEncoder',
        '//aios/storage/indexlib/index/inverted_index/format:PositionListFormat',
        '//aios/storage/indexlib/index/inverted_index/format:PositionListFormatOption',
        '//aios/storage/indexlib/index/inverted_index/format:PositionSkipListFormat',
        '//aios/storage/indexlib/index/inverted_index/format:PostingDecoder',
        '//aios/storage/indexlib/index/inverted_index/format:PostingDecoderImpl',
        '//aios/storage/indexlib/index/inverted_index/format:PostingFormat',
        '//aios/storage/indexlib/index/inverted_index/format:PostingFormatOption',
        '//aios/storage/indexlib/index/inverted_index/format:ShardingIndexHasher',
        '//aios/storage/indexlib/index/inverted_index/format:ShortListOptimizeUtil',
        '//aios/storage/indexlib/index/inverted_index/format:ShortListSegmentDecoder',
        '//aios/storage/indexlib/index/inverted_index/format:SkipListSegmentDecoder',
        '//aios/storage/indexlib/index/inverted_index/format:TermMeta',
        '//aios/storage/indexlib/index/inverted_index/format:TermMetaDumper',
        '//aios/storage/indexlib/index/inverted_index/format:TermMetaLoader',
        '//aios/storage/indexlib/table/normal_table:table',
        '//aios/unittest_framework'
    ]
)
